<script>
// ================== 常量定义 ==================
const ATTENUATION_LENGTH = 160;      // 中子衰减长度 (g/cm²)
const ROCK_DENSITY = 2.7;           // 标准岩石密度 (g/cm³)
const SEA_LEVEL_PRESSURE = 1013.25; // 海平面大气压 (hPa)

// 核素衰变常数 (yr⁻¹) - 根据最新核数据表
const decayConstants = {
    '10Be': 4.99e-7,  // Chmeleff et al. 2010
    '26Al': 9.83e-7   // Nishiizumi et al. 2007
};

// 基础产率 (atoms/g/yr) - 使用LSDn模型基准值
const BASE_PRODUCTION = {
    '10Be': 4.01,    // Stone 2000 海拔高纬度基准值
    '26Al': 28.1     // 对应Al/Be产率比7.0
};

// ================== 核心计算函数 ==================
function calculateAirPressure(elevation) {
    /** 
     * 计算站点大气压（简化模型）
     * @param {number} elevation 海拔高度（米）
     * @returns {number} 气压（hPa）
     */
    return SEA_LEVEL_PRESSURE * Math.exp(-elevation / 8400);
}

function elevationCorrection(elevation, lat) {
    /**
     * 海拔-纬度综合校正因子（基于Lifton-Sato-Dunai模型）
     * 修复关键错误：指数符号校正
     */
    const h = calculateAirPressure(elevation);
    const z = 1033 - h;  // 标准化气压差
    
    if (z <= 0) return 1.0;
    
    // 模型参数（Lifton et al. 2014）
    const params = {
        n: 1.0177e-2,
        k: 0.9615,
        alpha: 10.275,
        a: [
            8.5236e-6, -6.3670e-7, -7.0814e-9,
            -9.9182e-9, 9.9250e-10, 2.4925e-11,
            3.8615e-12, -4.8194e-13, -1.5371e-14
        ]
    };
    
    // 纬度效应计算
    const latRad = Math.abs(lat) * Math.PI / 180;
    const R_C = 14.9 * Math.pow(Math.cos(latRad), 4); // 截止刚度的纬度依赖
    
    // 四项式展开计算
    const term1 = (params.n / (1 + Math.exp(-params.alpha * Math.pow(R_C, -params.k)))) * z;
    const term2 = (params.a[0] + params.a[1]*R_C + params.a[2]*R_C**2) * z**2 / 2;
    const term3 = (params.a[3] + params.a[4]*R_C + params.a[5]*R_C**2) * z**3 / 3;
    const term4 = (params.a[6] + params.a[7]*R_C + params.a[8]*R_C**2) * z**4 / 4;
    
    const c = term1 + term2 + term3 + term4;
    return c > 0 ? Math.exp(z/c) : 1.0; // 关键修复：指数符号校正
}

function latitudeCorrection(lat) {
    /**
     * 纬度校正因子（Stone 2000多项式模型）
     * @param {number} lat 纬度（度）
     * @returns {number} 校正因子
     */
    const absLat = Math.abs(lat);
    return Math.min(1.0, 
        1.0 + 
        0.093 * Math.cos(absLat * Math.PI/180) - 
        0.024 * Math.cos(2 * absLat * Math.PI/180)
    );
}

function depthCorrection(depth) {
    /**
     * 深度衰减因子（指数衰减模型）
     * @param {number} depth 深度（厘米）
     */
    return Math.exp(-depth * ROCK_DENSITY / ATTENUATION_LENGTH);
}

function calculateProductionRate(elevation, lat, depth) {
    /**
     * 综合计算各核素产率
     * @returns {Object} 包含校正因子和各核素产率的对象
     */
    const elevCorr = elevationCorrection(elevation, lat);
    const latCorr = latitudeCorrection(lat);
    const depthCorr = depthCorrection(depth);

    const rates = {};
    for (const nuc in BASE_PRODUCTION) {
        rates[nuc] = BASE_PRODUCTION[nuc] * elevCorr * latCorr * depthCorr;
    }

    return {
        rates: rates,
        elevCorr: elevCorr,
        latCorr: latCorr,
        depthCorr: depthCorr
    };
}

// ================== 主计算函数 ==================
function calculateErosion() {
    // 界面状态重置
    document.getElementById('error-erosion').style.display = 'none';
    document.getElementById('results-erosion').style.display = 'none';
    document.querySelectorAll('#erosion-tab input').forEach(i => i.style.border = "1px solid #ccc");

    // 输入解析辅助函数
    const getInputValue = (id) => {
        const el = document.getElementById(id);
        const value = parseFloat(el.value);
        if (isNaN(value)) {
            el.style.border = "2px solid red";
            return null;
        }
        return value;
    };

    // 获取输入值
    const nuclide1 = document.getElementById('nuclide1').value;
    const conc1 = getInputValue('conc1');
    const nuclide2 = document.getElementById('nuclide2').value;
    const conc2 = getInputValue('conc2');
    const lat = getInputValue('latitude-erosion');
    const elev = getInputValue('elevation-erosion');
    const depth = getInputValue('depth-erosion');

    // 输入验证流程
    const errorEl = document.getElementById('error-erosion');
    if ([conc1, conc2, lat, elev, depth].some(v => v === null)) {
        errorEl.innerHTML = "错误：请填写所有输入项（必须为数字）";
        errorEl.style.display = 'block';
        return;
    }
    
    if (nuclide1 === nuclide2) {
        errorEl.innerHTML = "错误：必须选择两种不同的核素";
        errorEl.style.display = 'block';
        return;
    }
    
    if (Math.abs(lat) > 90) {
        errorEl.innerHTML = "错误：纬度范围必须为-90°至90°";
        errorEl.style.display = 'block';
        return;
    }

    if (elev < 0 || depth < 0) {
        errorEl.innerHTML = "错误：海拔和深度不能为负值";
        errorEl.style.display = 'block';
        return;
    }

    if (conc1 <= 0 || conc2 <= 0) {
        errorEl.innerHTML = "错误：核素浓度必须为正数";
        errorEl.style.display = 'block';
        return;
    }

    // 计算产率参数
    const production = calculateProductionRate(elev, lat, depth);
    const P1 = production.rates[nuclide1];
    const P2 = production.rates[nuclide2];
    const lambda1 = decayConstants[nuclide1];
    const lambda2 = decayConstants[nuclide2];
    
    // 计算浓度比率
    const ratio = (conc1 / P1) / (conc2 / P2);
    
    // 防止除零错误
    if (Math.abs(ratio - 1) < 1e-6) {
        errorEl.innerHTML = "错误：核素比率接近1，无法计算侵蚀速率";
        errorEl.style.display = 'block';
        return;
    }
    
    // 侵蚀速率计算（单位：cm/kyr）
    let epsilon;
    if (nuclide1 === '10Be' && nuclide2 === '26Al') {
        epsilon = ( (lambda2 - ratio*lambda1) * ATTENUATION_LENGTH ) / ( (ratio - 1) * ROCK_DENSITY ) * 1000;
    } else if (nuclide1 === '26Al' && nuclide2 === '10Be') {
        epsilon = ( (lambda1 - ratio*lambda2) * ATTENUATION_LENGTH ) / ( (ratio - 1) * ROCK_DENSITY ) * 1000;
    } else {
        errorEl.innerHTML = "错误：仅支持¹⁰Be-²⁶Al组合";
        errorEl.style.display = 'block';
        return;
    }
    
    // 结果有效性检查
    if (epsilon < 0) {
        errorEl.innerHTML = "错误：负侵蚀速率，可能数据不适用暴露年代模型";
        errorEl.style.display = 'block';
        return;
    }

    // 结果格式化输出
    const displayName = {
        '10Be': '¹⁰Be',
        '26Al': '²⁶Al'
    };
    
    let results = `<h3>${displayName[nuclide1]}-${displayName[nuclide2]}侵蚀速率结果</h3>`;
    results += `<div class="result-item">${displayName[nuclide1]}浓度：<b>${conc1.toExponential(2)} atoms/g</b></div>`;
    results += `<div class="result-item">${displayName[nuclide2]}浓度：<b>${conc2.toExponential(2)} atoms/g</b></div>`;
    results += `<div class="result-item">综合产率校正因子：${production.elevCorr.toFixed(3)} (海拔) × ${production.latCorr.toFixed(3)} (纬度) × ${production.depthCorr.toFixed(3)} (深度)</div>`;
    results += `<div class="result-highlight">侵蚀速率：<b>${epsilon.toFixed(2)} cm/kyr</b></div>`;
    
    // 调试信息
    results += `
        <div class="debug-info">
            <h4>模型参数详情：</h4>
            <div>中子衰减长度：${ATTENUATION_LENGTH} g/cm²</div>
            <div>岩石密度：${ROCK_DENSITY} g/cm³</div>
            <div>${displayName[nuclide1]}衰变常数：${lambda1.toExponential(2)} yr⁻¹</div>
            <div>${displayName[nuclide2]}衰变常数：${lambda2.toExponential(2)} yr⁻¹</div>
            <div>核素浓度比率：${ratio.toFixed(4)}</div>
        </div>
    `;

    // 显示结果
    const resultsEl = document.getElementById('results-erosion');
    resultsEl.innerHTML = results;
    resultsEl.style.display = 'block';
}
</script>
