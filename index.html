<script>
// 修复后的海拔校正函数
function elevationCorrection(elevation, lat) {
    const h = calculateAirPressure(elevation);
    const z = 1033 - h;
    
    if (z <= 0) return 1.0;
    
    const params = {
        n: 1.0177e-2,
        k: 0.9615,
        alpha: 10.275,
        a: [
            8.5236e-6, -6.3670e-7, -7.0814e-9,
            -9.9182e-9, 9.9250e-10, 2.4925e-11,
            3.8615e-12, -4.8194e-13, -1.5371e-14
        ]
    };
    
    const latRad = Math.abs(lat) * Math.PI / 180;
    const R_C = 14.9 * Math.pow(Math.cos(latRad), 4);
    
    // 修复括号匹配
    const term1 = (params.n / (1 + Math.exp(-params.alpha * Math.pow(R_C, -params.k)))) * z;
    const term2 = (params.a[0] + params.a[1]*R_C + params.a[2]*R_C**2) * z**2 / 2;
    const term3 = (params.a[3] + params.a[4]*R_C + params.a[5]*R_C**2) * z**3 / 3;
    const term4 = (params.a[6] + params.a[7]*R_C + params.a[8]*R_C**2) * z**4 / 4;
    
    const c = term1 + term2 + term3 + term4;
    return c > 0 ? Math.exp(-z/c) : 1.0;
}

// 修复后的侵蚀速率计算函数
function calculateErosion() {
    // ...其他代码保持不变...
    
    // 添加变量声明
    let i; 
    let currentRatio = 0;
    
    // 添加输入验证
    const minRatio = lambda1 / lambda2;
    if (targetRatio < minRatio) {
        errorEl.innerHTML = "错误：核素比值过低，可能数据无效";
        errorEl.style.display = 'block';
        return;
    }

    // 更新后的二分法循环
    for (i = 0; i < maxIterations; i++) {
        epsilon = (lower + upper) / 2;
        currentRatio = (lambda1 + epsilon/ATTENUATION_LENGTH) / 
                      (lambda2 + epsilon/ATTENUATION_LENGTH);
        
        if (Math.abs(currentRatio - targetRatio) < tolerance) {
            foundSolution = true;
            break;
        }

        if (currentRatio < targetRatio) {
            upper = epsilon;
        } else {
            lower = epsilon;
        }
    }

    // 修复单位转换
    const epsilonCMKYR = (epsilon / ROCK_DENSITY) * 1000; // 正确转换
    
    // 添加物理范围验证
    if (epsilonCMKYR < 0 || epsilonCMKYR > 100) {
        foundSolution = false;
    }

    // 更新结果显示
    let results = `<h3>${displayName1}-${displayName2}侵蚀速率计算结果:</h3>`;
    results += `<div class="debug-info">
        <div>测量比值: ${targetRatio.toFixed(4)}</div>
        <div>最终比值: ${currentRatio.toFixed(4)}</div>
        <div>迭代次数: ${i}</div>
        <div style="color:${foundSolution?'green':'red'}">侵蚀速率: 
            <b>${epsilonCMKYR.toFixed(2)} cm/kyr</b>
            ${foundSolution?'':'<span>(可能未收敛)</span>'}
        </div>
    </div>`;
    
    // ...剩余代码...
}
</script>
